<!doctype html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="author" content="Will, Stephanie, Hillary, Fokale, Patrick, Jas, Matt" />
    <meta name="keywords" content="clinical trials, participants, registration" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="icon" type="image/gif" href="favicon.gif" />
    <link href="../css/bootstrap.css" rel="stylesheet">
    <link href="../css/bootstrap-responsive.css" rel="stylesheet">

    <title>Target Accrual - Researcher Network</title>

    <style>
      #hover-info {
        position: relative;
        height: auto;
        width:100%;
        border-top: 1px solid black;
        border-bottom: 1px solid black;
        vertical-align:middle;
      }
      #container {
        padding-left:15%;
        padding-right:15%;
      }
      #more-info-box {
        position:absolute;
        background-color:white;
        border: 1px solid;
        height:50px;
        width:200px;
      }

      #header {
        margin-left: 10px;
      }

      section {
        margin-bottom: 25px;
      }

      #research-topic {
        height: 16px;
      }
    </style>
  </head>
  <body>
    <!--
    <div id='container'>
      <h2>Do not wait to strike till the iron is hot; but make it hot by striking.</h2>
      <div class='row'>
        <button id='clear-box'>Clear</button>         
      </div>
      <div class='row contain-graphic'>
        <div id='more-info-box'></div>
      </div>
      <div id="hover-info">
      </div>

    </div>
    -->


    <div class='row'>
      <div class='span12'>
        <h4 id='header'><a href="/">Target Accrual</a>
          <small>researcher network</small>
        </h4>
      </div>
    </div>

    <div class='row'>
      <div class='span10 contain-graphic'>
      </div>

      <div class='span2'>

        <section>
          <h5>Research Topic</h5>
          <input class='span2' id='research-topic' type="text" data-provide="typeahead">
        </section>

        <section>
          <h5>Legend</h5>
          <ul>
            <li>nodes: authors</li>
            <li>lines: co-authorship</li>
          </ul>
        </section>

        <section>
          <h5>Methods</h5>
          <p>Papers are extracted via PubMed searches on certain keywords
          and parsed for author information.  Scraper source code is available
          <a href="https://github.com/yosemitebandit/crabnet">on GitHub</a>.</p>
        </section>

      </div>

    </div>

  </body>

  <script src="../js/jquery.min.js"></script>
  <script type="text/javascript" src="../js/d3.v3.min.js"></script>

    <script type="text/javascript">
    $(document).ready(function(){
      $.getJSON('../network-data/chordoma.txt', function(response){
        var w = $('.contain-graphic').width(),
        h = $(window).height()-50,
        fill = d3.scale.category10(),
        nodes = d3.range(response.authorsOnly.length).map(Object),
        links = d3.range(response.authorPairs.length).map(Object);

        var hold_authors = d3.range(response.authorsOnly.length).map(Object);

        var index = 0;
        var mouseX = 0,
            mouseY = 0;

        for (var j = 0; j < response.authorPairs.length; j++){
          //console.log(j + ' author A ' + response.libraries[j].authorA + ' author B ' + response.libraries[j].authorB + ' value ' + response.libraries[j].paperCount);
          links[j] = {source: nodes[response.authorPairs[j].authorA], target: nodes[response.authorPairs[j].authorB], value: response.authorPairs[j].paperCount};
        }

        $.each(response.authorsOnly, function(i,entry){
          //console.log('here')
          hold_authors[i] = {id: entry.author_id, name: entry.author_name, paperCount: entry.papers.length, papers: entry.papers };
        })

      /*
      links.forEach(function(o,i){
        o.source = nodes[(Math.round(Math.random()*99))];
        o.target = nodes[(Math.round(Math.random()*99))];
        o.value = (Math.round(Math.random()*10));
      });
      */

      var vis = d3.select(".contain-graphic").append("svg:svg")
          .attr("width", w)
          .attr("height", h);

      var force = d3.layout.force()
          .nodes(nodes)
          .links(links)
          .size([w, h])
          .start()
          .gravity('0.25')
          .charge(-40)
          .linkDistance(function(d){
            return 1000-d.value;
          })

      var link = vis.selectAll('.link')
                    .data(links)
                  .enter().append('line')
                    .attr('class','link')
                    .style('stroke-width',function(d){
                      return Math.sqrt(d.value);
                    })
                    .attr('stroke','#999')
                    .attr('stroke-opacity', '0.6')

      var node = vis.selectAll("circle.node")
          .data(nodes)
        .enter().append("svg:circle")
          .attr("class", "node")
          .attr("cx", function(d) { return d.x; })
          .attr("cy", function(d) { return d.y; })
          .attr("r", function(d,i){
            return hold_authors[i].paperCount;
          })
          .attr('opacity', .6)
          .style("fill", function(d, i) { return 'red'; })
          .style("stroke", function(d, i) { return d3.rgb(fill(i & 3)).darker(2); })
          .style("stroke-width", 1.5)
          .on('click', more_info)

      vis.style("opacity", 1e-6)
        .transition()
          .duration(1000)
          .style("opacity", 1);

      force.on("tick", function(e) {
        // Push different nodes in different directions for clustering.
        var k = 6 * e.alpha;
        nodes.forEach(function(o, i) {
          //o.y += i & 1 ? k : -k;
          //o.x += i & 2 ? k : -k;
        });

        link.attr("x1", function(d) { return (d.source.x); })
            .attr("y1", function(d) { return (d.source.y); })
            .attr("x2", function(d) { return (d.target.x); })
            .attr("y2", function(d) { return (d.target.y); });

        node.attr("cx", function(d) { return (d.x); })
            .attr("cy", function(d) { return (d.y); });
      });

      /*d3.select("body").on("click", function() {
        nodes.forEach(function(o, i) {
          o.x += (Math.random() - .5) * 40;
          o.y += (Math.random() - .5) * 40;
        });

        alert('here');
        links.forEach(function(o,i){
          o.source = nodes[(Math.round(Math.random()*99))];
          o.target = nodes[(Math.round(Math.random()*99))];
          o.value = (Math.round(Math.random()*10));
        });

        force.resume();
      });*/

      function hover(d) {
        var index = [];
        links.forEach(function(link,i){
          //console.log('link ' + link.source.x + ' ' + link.source.y)
          //console.log('link ' + link.source.x + ' ' + link.source.y)
          //console.log('node ' + d.x + ' ' + d.y);console.log('node ' + d.x + ' ' + d.y);
          if ((link.source.x == d.x & link.source.y == d.y) | (link.target.x == d.x & link.target.y == d.y)){
            index.push(i);
          }
        });

        var num = Math.random()*40;

        d3.select("#hover-info")
            .html('Author' + 'Professor X' + "<br/>Papers: " + d.x);

        link.attr('stroke', function(d, i){
          if (index.indexOf(i) > -1) {
            return 'green';
          }
        }) 

        //alert(d==d);


       /* node
          .attr('fill', function(node_object){
            index.forEach(function(real_index,i){
              console.log(real_index);
              console.log('link ' + links[real_index].source.x + ' ' + links[real_index].source.y)
              console.log('node ' + node_object.x + ' ' + node_object.y);
              if ((links[real_index].source.x == node_object.x & links[real_index].source.y == node_object.y) | 
                  (links[real_index].target.x == node_object.x & links[real_index].target.y == node_object.y)){
                alert('here');
                return 'red';
              }
            })
            return null; 
          })*/

      };

      function offhover(d){
          link.attr('stroke', '#999')
          node
            .attr('opacity', function(d){
                return 1; })
      }

      function more_info(d){
        $('#more-info-box').css('display', 'block');
        $('#more-info-box').css('left', mouseX);
        $('#more-info-box').css('top', mouseY);

        var index = 0;

        nodes.forEach(function(node,i){
          //console.log('link ' + link.source.x + ' ' + link.source.y)
          //console.log('link ' + link.source.x + ' ' + link.source.y)
          //console.log('node ' + d.x + ' ' + d.y);console.log('node ' + d.x + ' ' + d.y);
          if (node.x == d.x & node.y == d.y){
            index = i;
          }
        });

        d3.select('#more-info-box')
          .html('Author ' + hold_authors[index].name + "<br/>Papers: " + hold_authors[index].paperCount);

        d3.select("#hover-info")
          .html('Author ' +  hold_authors[index].name + "<br/>Papers: " + hold_authors[index].paperCount + "<br/>PubMed papers:<br><ul></ul>"
            );

              console.log(hold_authors[index].papers)

        $.map(hold_authors[index].papers, function(d){
              console.log(d)
              $('#hover-info ul').append('<li>'+d+'</li>');
        })
      }

      $('#clear-box').click(function(){
        $('#more-info-box').css('display', 'none');
      })

      $(document).mousemove(function(e){
        mouseX = e.pageX;
        mouseY = e.pageY;
      })
            })});
   </script>
 </html>
