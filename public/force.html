<html>
    <head>
        <title>D3 Test</title>
        <script type="text/javascript" src="http://code.jquery.com/jquery.js"></script>
        <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
        <link href="stylesheets/bootstrap.min.css" rel="stylesheet" media="screen">
        <script src="scripts/bootstrap.min.js"></script>
      <style>
        #hover-info {
          position: relative;
          height: 50px;
          width:100%;
          border-top: 1px solid black;
          border-bottom: 1px solid black;
          vertical-align:middle;
        }
        #container {
          padding-left:15%;
          padding-right:15%;
        }
        #more-info-box {
          position:absolute;
          background-color:red;
          height:50px;
          width:100px;
        }
      </style>
    </head>
    <body>
      <div id='container'>
        <h2>The best way out is always through.</h2>
        <div class='row'>
             <button id='clear-box'>Clear</button>
          <div id="hover-info">
         
          </div>
          <div id='more-info-box'></div>
        </div>
      </div>
    </body>
    <script type="text/javascript">
    $(document).ready(function(){
      $.getJSON('/papers.txt', function(response){
        var w = 1280,
        h = 900,
        fill = d3.scale.category10(),
        nodes = d3.range(response.authors.length).map(Object),
        links = d3.range(response.libraries.length).map(Object);

        var hold_authors = d3.range(response.authors.length).map(Object);

        var index = 0;
        var mouseX = 0,
            mouseY = 0;

        for (var j = 0; j < response.libraries.length; j++){
          //console.log(j + ' author A ' + response.libraries[j].authorA + ' author B ' + response.libraries[j].authorB + ' value ' + response.libraries[j].paperCount);
          links[j] = {source: nodes[response.libraries[j].authorA], target: nodes[response.libraries[j].authorB], value: response.libraries[j].paperCount};
        }

        $.each(response.authors, function(i,entry){
          //console.log('here')
          hold_authors[i] = {name: entry.author, paperCount: entry.papers.length, paper: entry.papers };
        })

      /*
      links.forEach(function(o,i){
        o.source = nodes[(Math.round(Math.random()*99))];
        o.target = nodes[(Math.round(Math.random()*99))];
        o.value = (Math.round(Math.random()*10));
      });
      */

      var vis = d3.select("#container").append("svg:svg")
          .attr("width", w)
          .attr("height", h);

      var force = d3.layout.force()
          .nodes(nodes)
          .links(links)
          .size([w, h])
          .start()
          .gravity('0.07')

      var link = vis.selectAll('.link')
                    .data(links)
                  .enter().append('line')
                    .attr('class','link')
                    .style('stroke-width',function(d){
                      return Math.sqrt(d.value);
                    })
                    .attr('stroke','#999')
                    .attr('stroke-opacity', '0.6')

      var node = vis.selectAll("circle.node")
          .data(nodes)
        .enter().append("svg:circle")
          .attr("class", "node")
          .attr("cx", function(d) { return d.x; })
          .attr("cy", function(d) { return d.y; })
          .attr("r", 8)
          .style("fill", function(d, i) { return 'black'; })
          .style("stroke", function(d, i) { return d3.rgb(fill(i & 3)).darker(2); })
          .style("stroke-width", 1.5)
          .on("mouseover", hover)
          .on("mouseout", offhover)
          .on('click', more_info);

      vis.style("opacity", 1e-6)
        .transition()
          .duration(1000)
          .style("opacity", 1);

      force.on("tick", function(e) {
        // Push different nodes in different directions for clustering.
        var k = 6 * e.alpha;
        nodes.forEach(function(o, i) {
          //o.y += i & 1 ? k : -k;
          //o.x += i & 2 ? k : -k;
        });

        link.attr("x1", function(d) { return (d.source.x); })
            .attr("y1", function(d) { return (d.source.y); })
            .attr("x2", function(d) { return (d.target.x); })
            .attr("y2", function(d) { return (d.target.y); });

        node.attr("cx", function(d) { return (d.x); })
            .attr("cy", function(d) { return (d.y); });
      });

      /*d3.select("body").on("click", function() {
        nodes.forEach(function(o, i) {
          o.x += (Math.random() - .5) * 40;
          o.y += (Math.random() - .5) * 40;
        });

        alert('here');
        links.forEach(function(o,i){
          o.source = nodes[(Math.round(Math.random()*99))];
          o.target = nodes[(Math.round(Math.random()*99))];
          o.value = (Math.round(Math.random()*10));
        });

        force.resume();
      });*/

      function hover(d) {
        var index = [];
        links.forEach(function(link,i){
          //console.log('link ' + link.source.x + ' ' + link.source.y)
          //console.log('link ' + link.source.x + ' ' + link.source.y)
          //console.log('node ' + d.x + ' ' + d.y);console.log('node ' + d.x + ' ' + d.y);
          if ((link.source.x == d.x & link.source.y == d.y) | (link.target.x == d.x & link.target.y == d.y)){
            index.push(i);
          }
        });

        var num = Math.random()*40;

        d3.select("#hover-info")
            .html('Author' + 'Professor X' + "<br/>Papers: " + d.x);

        link.attr('stroke', function(d, i){
          if (index.indexOf(i) > -1) {
            return 'green';
          }
        }) 

        //alert(d==d);


       /* node
          .attr('fill', function(node_object){
            index.forEach(function(real_index,i){
              console.log(real_index);
              console.log('link ' + links[real_index].source.x + ' ' + links[real_index].source.y)
              console.log('node ' + node_object.x + ' ' + node_object.y);
              if ((links[real_index].source.x == node_object.x & links[real_index].source.y == node_object.y) | 
                  (links[real_index].target.x == node_object.x & links[real_index].target.y == node_object.y)){
                alert('here');
                return 'red';
              }
            })
            return null; 
          })*/

      };

      function offhover(d){
          link.attr('stroke', '#999')
          node
            .attr('opacity', function(d){
                return 1; })
      }

      function more_info(d){
        $('#more-info-box').css('display', 'block');
        $('#more-info-box').css('left', mouseX);
        $('#more-info-box').css('top', mouseY);

        var index = 0;

        nodes.forEach(function(node,i){
          //console.log('link ' + link.source.x + ' ' + link.source.y)
          //console.log('link ' + link.source.x + ' ' + link.source.y)
          //console.log('node ' + d.x + ' ' + d.y);console.log('node ' + d.x + ' ' + d.y);
          if (node.x == d.x & node.y == d.y){
            index = i;
          }
        });

        d3.select('#more-info-box')
          .html('Author' + hold_authors[index].name + "<br/>Papers: " + hold_authors[index].paperCount);
      }

      $('#clear-box').click(function(){
        $('#more-info-box').css('display', 'none');
      })

      $(document).mousemove(function(e){
        mouseX = e.pageX;
        mouseY = e.pageY;
      })
            })});
   </script>
 </html>
